<html>
  <head>
  <script type="text/javascript" src="./bower_components/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="./bower_components/polymer/polymer.html" />
  <script type="text/javascript" src="../sim.js"></script>
  <link rel="stylesheet" href="examples.css" type="text/css" />
  <dom-module id="s-pick">
    <template>
      <div class="form">
      <table>
        <tr>
          <td>Buffer Capacity: </td>
          <td><input type="text" value="{{capacity}}"/></td>
        </tr>
        <tr>
          <td>Salad preparation time (min):</td>
          <td><input type="text" value="{{preparationTime}}"/></td>
        </tr>
        <tr>
          <td>Mean interval between customer arrivals (min):</td>
          <td><input type="text" value="{{meanInterval}}" /></td>
        </tr>
        <tr>
          <td>Mean cashier transaction time (min):</td>
          <td><input type="text" value="{{transactionTime}}" /></td>
        </tr>
        <tr>
          <td>Random number generation seed:</td>
          <td><input type="text" value="{{randomSeed}}" /></td>
        </tr>
        <tr>
          <td>Simulation time (min):</td>
          <td><input type="text" value="{{simTime}}"/></td>
        </tr>
      </table>
      <button on-click="_runSimulation">Run Simulation</button>
      </div>
      <template is="dom-repeat" items="[[results]]">
        <p>
          Simulation Results for:
          Pick Capacity = [[item.capacity]],
          Preparation Time = [[item.preparationTime]]
          Mean Arrival = [[item.meanArrival]]
          Seed = [[item.randomSeed]]
          Sim time = [[item.simTime]]
          <br>
          Average time at pick (min) = [[item.results_0]]
          Average number of customers in restaurant = [[item.results_2]]
        </p>
      </template>
      <button on-click="_clearResults">Clear</button>
    </template>
    <script>
      var Sim = require('../sim.js');
      Polymer({
        is: 's-pick',
        properties: {
          capacity: {
            type: Number,
            notify: true,
            value: 5
          },
          preparationTime: {
            type: Number,
            notify: true,
            value: 5
          },
          meanInterval: {
            type: Number,
            notify: true,
            value: 1
          },
          transactionTime: {
            type: Number,
            notify: true,
            value: 1
          },
          randomSeed: {
            type: String,
            notify: true,
            value: '1234'
          },
          simTime: {
            type: Number,
            notify: true,
            value: 240
          },
          results: {
            type: Array,
            value: [],
            notify: true
          }
        },
        _runSimulation() {
          var results = pickSimulation(
              this.capacity,
              this.preparationTime,
              this.meanArrival,
              this.transactionTime,
              this.randomSeed,
              this.simTime);

          var msg = {
            capacity: this.capacity,
            preparationTime: this.preparationTime,
            meanArrival: this.meanArrival,
            transactionTime: this.transactionTime,
            randomSeed: this.randomSeed,
            simTime: this.simTime,
            results_0: results[0].toFixed(4),
            results_2: results[2].toFixed(4)
          };
          this.push('results', msg);
        },
        _clearResults() {
          this.set('results', []);
        }
      });
      function pickSimulation(
              BuffetCapacity,
              PreparationTime,
              MeanArrival,
              CashierTime,
              Seed,
              Simtime)
      {
          var sim = new Sim.Sim();
          var stats = new Sim.Population();
          var cashier = new Sim.Facility('Cashier');
          var buffet = new Sim.Buffer('Buffet', BuffetCapacity);
          var random = new Random(Seed);

          var Customer = {
              start: function () {
                  this.order();

                  var nextCustomerAt = random.exponential (1.0 / MeanArrival);
                  this.setTimer(nextCustomerAt).done(this.start);
              },

              order: function () {
                  sim.log("Customer ENTER at " + this.time());
                  stats.enter(this.time());

                  this.getBuffer(buffet, 1).done(function () {
                      sim.log("Customer at CASHIER " + this.time() + " (entered at " + this.callbackData + ")");
                      var serviceTime = random.exponential(1.0 / CashierTime);
                      this.useFacility(cashier, serviceTime).done(function () {
                          sim.log("Customer LEAVE at " + this.time() + " (entered at " + this.callbackData + ")");
                          stats.leave(this.callbackData, this.time());
                      }).setData(this.callbackData);
                  }).setData(this.time());
              }
          };

          var Chef = {
              start: function () {
                  this.putBuffer(buffet, BuffetCapacity - buffet.current());
                  this.setTimer(PreparationTime).done(this.start);
              }
          };

          sim.addEntity(Customer);
          sim.addEntity(Chef);

      //  Uncomment these line to display logging information
      //    sim.setLogger(function (msg) {
      //        document.write(msg);
      //    });

          sim.simulate(Simtime);

          return [stats.durationSeries.average(),
                  stats.durationSeries.deviation(),
                  stats.sizeSeries.average(),
                  stats.sizeSeries.deviation()];

      }
    </script>
  </dom-module>
  </head>
  <body>
    <s-pick></s-pick>
  </body>
</html>


