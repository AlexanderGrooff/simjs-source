<html>
  <head>
  <script type="text/javascript" src="./bower_components/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="./bower_components/polymer/polymer.html" />
  <script type="text/javascript" src="../bower_components/requirejs/require.js"></script>
  <script type="text/javascript" src="../sim.js"></script>
  <link rel="stylesheet" href="examples.css" type="text/css" />
  <dom-module id="s-pick">
    <template>
      <div class="form">
      <table>
        <tr>
          <td>Pallet Tray Capacity: </td>
          <td><input type="text" value="{{capacity::input}}"/></td>
        </tr>
        <tr>
          <td>Mean single pick transaction time (min):</td>
          <td><input type="text" value="{{transactionTime::input}}" /></td>
        </tr>
        <tr>
          <td>Random number generation seed:</td>
          <td><input type="text" value="{{randomSeed::input}}" /></td>
        </tr>
        <tr>
          <td>Simulation time (min):</td>
          <td><input type="text" value="{{simTime::input}}"/></td>
        </tr>
      </table>
      <button on-click="_runSimulation">Run Simulation</button>
      </div>
      <template is="dom-repeat" items="[[results]]">
        <p>
          Simulation Results for:
          Pallet Tray Capacity = [[item.capacity]],
          Seed = [[item.randomSeed]]
          Sim time = [[item.simTime]]
          <br>
          Average time at pick (min) = [[item.results_0]]
          Average number of customers in restaurant = [[item.results_2]]
        </p>
      </template>
      <button on-click="_clearResults">Clear</button>
    </template>
    <script>
      var Sim;
      Polymer({
        is: 's-pick',
        properties: {
          capacity: {
            type: Number,
            notify: true,
            value: 5
          },
          transactionTime: {
            type: Number,
            notify: true,
            value: 10
          },
          randomSeed: {
            type: Number,
            notify: true,
            value: 1234
          },
          simTime: {
            type: Number,
            notify: true,
            value: 100
          },
          results: {
            type: Array,
            value: [],
            notify: true
          }
        },
        _runSimulation() {
          var results = pickSimulation(
              this.capacity,
              this.transactionTime,
              this.randomSeed,
              this.simTime);

          this.push('results', results);
        },
        _clearResults() {
          this.set('results', []);
        }
      });
      function pickSimulation(
          capacity,
          transactionTime,
          randomSeed,
          simTime) {
          var sim = new Sim.Sim();
          var pjWait = new Sim.Population('Waiting for Pallet Jack');
          var palletJack = new Sim.Facility('Pallet Jack');
          var palletTray = new Sim.Buffer('Pallet Tray With Product', capacity, capacity);
          var random = new Sim.Random(randomSeed);

          class Picker extends Sim.Entity {
            constructor(...args) {
              super(...args)
              this.itemCount = 0;
            }

            start(name) {
              if (name) this.name = name;

              this.startTime = this.time();
              this.log(`started picking (total: ${this.itemCount}, left: ${palletTray.current()})`);

              pjWait.enter(this.startTime);

              this.useFacility(palletJack, 10)
                .done(pjWait.leave, pjWait, [this.startTime, this.time()])
                .done(this.getBuffer, this, [palletTray, 2])
                .done(() => this.itemCount += 2)
                .done(this.start);
            }
          }

          sim.setLogger((...args) => console.log(...args));
          sim.addEntity(Picker, 'Picker 1');

          sim.simulate(simTime);

          return pjWait;
      };
    </script>
  </dom-module>
  </head>
  <body>
    <s-pick></s-pick>
  </body>
</html>


